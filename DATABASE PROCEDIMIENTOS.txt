-- Crear la base de datos PROCEDIMIENTOS
CREATE DATABASE PROCEDIMIENTOS;

-- Usar la base de datos PROCEDIMIENTOS
USE PROCEDIMIENTOS;

-- Crear la tabla BLOG
CREATE TABLE BLOG (
    ID_BLOG INT AUTO_INCREMENT PRIMARY KEY,
    FECHA DATE,
    AUTOR VARCHAR(255),
    TITULO VARCHAR(255),
    CONTENIDO TEXT
);

-- Crear la tabla NOTIFICACIÓN
CREATE TABLE NOTIFICACION (
    ID INT AUTO_INCREMENT PRIMARY KEY,
    ID_BLOG INT,
    FECHA DATE,
    NOTIFICACION VARCHAR(255),
    FOREIGN KEY (ID_BLOG) REFERENCES BLOG(ID_BLOG) ON DELETE CASCADE
);

-- Crear el procedimiento almacenado para insertar una nueva entrada en BLOG y registrar en NOTIFICACIÓN
DELIMITER $$
CREATE PROCEDURE INSERTAR_ENTRADA_BLOG(
    IN p_FECHA DATE,
    IN p_AUTOR VARCHAR(255),
    IN p_TITULO VARCHAR(255),
    IN p_CONTENIDO TEXT
)
BEGIN
    -- Insertar la nueva entrada en la tabla BLOG
    INSERT INTO BLOG (FECHA, AUTOR, TITULO, CONTENIDO) VALUES (p_FECHA, p_AUTOR, p_TITULO, p_CONTENIDO);
    
    -- Registrar la notificación en la tabla NOTIFICACIÓN
    INSERT INTO NOTIFICACION (ID_BLOG, FECHA, NOTIFICACION) VALUES (LAST_INSERT_ID(), p_FECHA, 'Se ha ingresado una nueva entrada en el blog');
END$$
DELIMITER ;
DELIMITER $$
-- Crear el trigger para eliminar el registro correspondiente a la tabla blog cuando se borre el registro de la tabla notificación
CREATE TRIGGER DELETE_BLOG_ENTRY
AFTER DELETE ON NOTIFICACION
FOR EACH ROW
BEGIN
    DELETE FROM BLOG WHERE ID_BLOG = OLD.ID_BLOG;
END$$
DELIMITER ;

call INSERTAR_ENTRADA_BLOG ("2020-04-02", "CAMILO", "LA ROSA", "LIBRO DE AMOR");
call INSERTAR_ENTRADA_BLOG ("2020-03-10", "ANDREA", "PERSONAS", "ESCRITO SOBRE LA VIDA");
INSERT INTO NOTIFICACION (ID_BLOG, FECHA, NOTIFICACION) VALUES (8, "2021-04-15", "Se ha ingresado una nueva cosa");

SELECT * FROM BLOG;
SELECT * FROM NOTIFICACION;

DELETE FROM BLOG WHERE ID_BLOG=8;